name: Create Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0, v2.1, etc.

jobs:
  release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Cache plugin-sdk
      id: cache-plugin-sdk
      uses: actions/cache@v4
      with:
        path: C:\plugin-sdk
        key: plugin-sdk-${{ runner.os }}-v2

    - name: Download and setup plugin-sdk
      if: steps.cache-plugin-sdk.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/DK22Pac/plugin-sdk.git C:\plugin-sdk
        cd C:\plugin-sdk
        Write-Host "Initializing submodules..."
        git submodule init
        git submodule update --recursive
        Write-Host "Submodule status:"
        git submodule status --recursive

        # Download tl::expected header for safetyhook
        Write-Host "Downloading tl::expected library..."
        $expectedDir = "safetyhook\tl-expected"
        New-Item -ItemType Directory -Force -Path $expectedDir | Out-Null
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/TartanLlama/expected/master/include/tl/expected.hpp" -OutFile "$expectedDir\expected.hpp"

        # Create a wrapper expected header that just redirects to tl/expected.hpp
        Set-Content -Path "safetyhook\expected" -Value "#pragma once`n#include `"tl-expected/expected.hpp`""

        # Patch safetyhook.hpp to use tl::expected instead of std::expected
        $content = Get-Content "safetyhook\safetyhook.hpp" -Raw
        $content = $content -replace '#include <expected>', '#include "expected"'
        $content = $content -replace 'std::expected', 'tl::expected'
        $content = $content -replace 'std::unexpected', 'tl::unexpected'
        Set-Content "safetyhook\safetyhook.hpp" -Value $content -NoNewline
        Write-Host "Patched safetyhook.hpp to use tl::expected"

    - name: Set PLUGIN_SDK_DIR
      run: echo "PLUGIN_SDK_DIR=C:\plugin-sdk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Build GTA Vice City version
      run: msbuild FramerateVigilante.sln /p:Configuration="GTAVC Release" /p:Platform=x86 /v:minimal
      env:
        PLUGIN_SDK_DIR: C:\plugin-sdk

    - name: Prepare release package
      run: |
        mkdir FramerateVigilante
        Copy-Item bin\GTAVC\Release\FramerateVigilante.VC.asi FramerateVigilante\
        Copy-Item FramerateVigilante.ini FramerateVigilante\
        Copy-Item README.md FramerateVigilante\
        Copy-Item LICENSE FramerateVigilante\
        Compress-Archive -Path FramerateVigilante -DestinationPath FramerateVigilante-${{ github.ref_name }}.zip

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: FramerateVigilante-${{ github.ref_name }}.zip
        body: |
          ## FramerateVigilante ${{ github.ref_name }}

          Fixes framerate-dependent bugs in GTA Vice City.

          ### Included files:
          - `FramerateVigilante.VC.asi` - GTA Vice City
          - `FramerateVigilante.ini` - Configuration file

          ### Installation:
          1. Install a mod loader (e.g., modloader, ASI Loader)
          2. Copy `FramerateVigilante.VC.asi` to your GTA Vice City directory
          3. (Optional) Edit FramerateVigilante.ini to configure settings

          ### Linux/Proton users:
          The siren fix has been improved for Proton compatibility. If you still experience crashes, set `EnableSirenFix = 0` in the INI file.

          ### Changes in this release:
          - Fixed crash at 0x00597a5d in SirenTurnOnFix (Linux/Proton)
          - Rewrote siren fix to use proper assembly jumps instead of stack manipulation
          - Added EnableSirenFix config option for compatibility
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
